from flask_mail import Mail, Message
from datetime import datetime
import threading
import time
import logging
import os
from flask import current_app
import pytz
from dotenv import load_dotenv

# Load environment variables from .env file
load_dotenv()

# Initialize Flask-Mail
mail = Mail()

# Email recipients from .env
TEST_RECIPIENTS = [
    os.getenv('TEST_EMAIL_1'),
    os.getenv('TEST_EMAIL_2'), 
    os.getenv('TEST_EMAIL_3')
]

def init_mail_service(app):
    """Initialize Flask-Mail with .env configuration"""
    app.config['MAIL_SERVER'] = os.getenv('MAIL_SERVER')
    app.config['MAIL_PORT'] = int(os.getenv('MAIL_PORT', 587))
    app.config['MAIL_USE_TLS'] = os.getenv('MAIL_USE_TLS', 'True').lower() == 'true'
    app.config['MAIL_USERNAME'] = os.getenv('MAIL_USERNAME')
    app.config['MAIL_PASSWORD'] = os.getenv('MAIL_PASSWORD')
    app.config['MAIL_DEFAULT_SENDER'] = os.getenv('MAIL_DEFAULT_SENDER')
    
    mail.init_app(app)
    
    # Configure logging
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(levelname)s - %(message)s',
        handlers=[logging.StreamHandler()]
    )
    
    logging.info("ğŸ“§ SMTP Service initialized by Subhash")


def send_single_email(to_email, subject, message):
    """Send email to single recipient"""
    try:
        msg = Message(
            subject, 
            sender=current_app.config['MAIL_DEFAULT_SENDER'],
            recipients=[to_email]
        )
        msg.body = message
        mail.send(msg)
        logging.info(f"âœ… Email sent successfully to {to_email}")
        return True
    except Exception as e:
        logging.error(f"âŒ Failed to send email to {to_email}: {str(e)}")
        return False


def get_current_time():
    """Get current IST time"""
    try:
        ist = pytz.timezone('Asia/Kolkata')
        return datetime.now(ist)
    except:
        return datetime.now()


def send_test_emails():
    """Send test emails to configured recipients"""
    try:
        now = get_current_time()
        current_date = now.strftime('%A, %B %d, %Y')
        current_time = now.strftime('%I:%M %p')
        
        subject = f"SMTP Test Email - {now.strftime('%d/%m/%Y %H:%M')}"
        
        message = f"""Hello!

This is a test email from SMTP Configuration System.

ğŸ“§ SMTP Testing by: Subhash
ğŸ“… Date: {current_date}
ğŸ• Time: {current_time} IST

âœ… SMTP Configuration Status: Working
ğŸŒ Server: {os.getenv('MAIL_SERVER')}
ğŸ”§ System: Automated Email Testing

If you receive this email, SMTP configuration is working perfectly!

Best regards,
Subhash
SMTP Testing System

---
Automated test email from Render deployment"""

        success_count = 0
        total_emails = len([email for email in TEST_RECIPIENTS if email])
        
        logging.info(f"ğŸ“§ Sending test emails to {total_emails} recipients...")
        
        for email in TEST_RECIPIENTS:
            if email:  # Only send to valid email addresses
                if send_single_email(email, subject, message):
                    success_count += 1
                time.sleep(1)  # Small delay between emails
        
        logging.info(f"âœ… Test emails completed: {success_count}/{total_emails} sent")
        return success_count
        
    except Exception as e:
        logging.error(f"âŒ Error in send_test_emails: {str(e)}")
        return 0


def send_smtp_status_report():
    """Send SMTP status report"""
    try:
        now = get_current_time()
        
        subject = f"ğŸ“Š SMTP System Status Report - {now.strftime('%d/%m/%Y')}"
        
        message = f"""SMTP Configuration Status Report
Generated by: Subhash

ğŸ• Report Time: {now.strftime('%Y-%m-%d %H:%M:%S')} IST

ğŸ“§ SMTP Configuration:
â€¢ Server: {os.getenv('MAIL_SERVER')}
â€¢ Port: {os.getenv('MAIL_PORT')}
â€¢ TLS: {os.getenv('MAIL_USE_TLS')}
â€¢ Sender: {os.getenv('MAIL_DEFAULT_SENDER')}

ğŸ“¨ Test Recipients:
â€¢ {os.getenv('TEST_EMAIL_1')}
â€¢ {os.getenv('TEST_EMAIL_2')}
â€¢ {os.getenv('TEST_EMAIL_3')}

âœ… System Status: Operational
ğŸŒ Environment: {os.getenv('ENVIRONMENT', 'production')}
ğŸ‘¨â€ğŸ’» Configured by: Subhash

---
SMTP Testing and Configuration System
Deployed on Render Cloud"""

        success_count = 0
        for email in TEST_RECIPIENTS:
            if email:
                if send_single_email(email, subject, message):
                    success_count += 1
        
        return success_count
        
    except Exception as e:
        logging.error(f"âŒ Error sending status report: {str(e)}")
        return 0


def run_daily_smtp_test(app):
    """Run SMTP test every 24 hours - ONLY ONCE PER DAY"""
    logging.info("ğŸš€ SMTP Testing Scheduler started by Subhash")
    
    # Initial delay
    time.sleep(30)
    
    while True:
        try:
            start_time = get_current_time()
            logging.info(f"â° Starting daily SMTP test: {start_time.strftime('%Y-%m-%d %H:%M:%S')} IST")
            
            with app.app_context():
                # ğŸ”¹ SEND ONLY ONE SET OF EMAILS PER DAY
                test_count = send_test_emails()
            
            end_time = get_current_time()
            duration = (end_time - start_time).total_seconds()
            
            logging.info(f"âœ… Daily SMTP test completed in {duration:.1f}s")
            logging.info(f"ğŸ“§ Emails sent to {test_count} recipients")
            
        except Exception as e:
            logging.error(f"âŒ SMTP test error: {str(e)}")
        
        logging.info("ğŸ˜´ Next SMTP test in 24 hours...")
        time.sleep(86400)  # 24 hours


def start_smtp_scheduler(app):
    """Initialize SMTP testing scheduler"""
    try:
        thread = threading.Thread(
            target=run_daily_smtp_test, 
            args=(app,), 
            name="SMTPTestScheduler",
            daemon=True
        )
        thread.start()
        
        logging.info("ğŸ“¬ SMTP Testing Scheduler started successfully!")
        logging.info(f"ğŸ“§ Test emails will be sent to: {len([e for e in TEST_RECIPIENTS if e])} addresses")
        logging.info("ğŸ‘¨â€ğŸ’» SMTP System configured by: Subhash")
        
        return True
        
    except Exception as e:
        logging.error(f"âŒ Failed to start SMTP scheduler: {str(e)}")
        return False


def get_smtp_health():
    """Get SMTP system health status"""
    active_threads = threading.active_count()
    thread_names = [t.name for t in threading.enumerate()]
    now = get_current_time()
    
    return {
        "status": "healthy" if "SMTPTestScheduler" in thread_names else "unhealthy",
        "smtp_server": os.getenv('MAIL_SERVER'),
        "smtp_port": os.getenv('MAIL_PORT'),
        "configured_by": "Subhash",
        "active_threads": active_threads,
        "scheduler_running": "SMTPTestScheduler" in thread_names,
        "test_recipients": len([e for e in TEST_RECIPIENTS if e]),
        "timestamp": now.strftime('%Y-%m-%d %H:%M:%S IST')
    }